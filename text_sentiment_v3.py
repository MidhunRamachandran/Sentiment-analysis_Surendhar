import re, json, codecs, csv
import nltk
import requests
from nltk.stem import PorterStemmer, SnowballStemmer, LancasterStemmer
from nltk.sentiment.vader import SentimentIntensityAnalyzer
sia = SentimentIntensityAnalyzer()
from nltk.stem.wordnet import WordNetLemmatizer
from textblob import TextBlob
import pandas as pd
from nltk.tokenize import RegexpTokenizer
import contractions

onfile = codecs.open("mentions_classification_file.tsv", mode="w", encoding='utf-8')
onfile.write("UID\tProduct_ID\tReview_ID\tReview_Text\tMatched_token\tTheme\tSubtheme\n")

mentions_text = [{"token":"value for money","theme":"price","subtheme":"affordable price"},{"token":"very cheap","theme":"price","subtheme":"cheaper price"},{"token":"very expensive","theme":"price","subtheme":"expensive"},{"token":"bang for buck","theme":"price","subtheme":"affordable price"},{"token":"good price","theme":"price","subtheme":"affordable price"},{"token":"affordable price","theme":"price","subtheme":"affordable price"},{"token":"affordable cost","theme":"price","subtheme":"affordable price"},{"token":"affordable product","theme":"price","subtheme":"affordable price"},{"token":"affordable pan","theme":"price","subtheme":"affordable price"},{"token":"affordable kadai","theme":"price","subtheme":"affordable price"},{"token":"cheap pan","theme":"price","subtheme":"cheaper price"},{"token":"cheap kadai","theme":"price","subtheme":"cheaper price"},{"token":"over priced","theme":"price","subtheme":"expensive"},{"token":"very pricey","theme":"price","subtheme":"expensive"},{"token":"pricey product","theme":"price","subtheme":"expensive"},{"token":"premium price","theme":"price","subtheme":"expensive"},{"token":"worth\u00a0the\u00a0money","theme":"price","subtheme":"affordable price"},{"token":"worth\u00a0the price","theme":"price","subtheme":"affordable price"},{"token":"price is high","theme":"price","subtheme":"expensive"},{"token":"worth every penny","theme":"price","subtheme":"affordable price"},{"token":"price not justifying","theme":"price","subtheme":"expensive"},{"token":"overpriced","theme":"price","subtheme":"expensive"},{"token":"expensive but worth","theme":"price","subtheme":"expensive"},{"token":"little costly","theme":"price","subtheme":"expensive"},{"token":"good investment","theme":"price","subtheme":"affordable price"},{"token":"price little costly","theme":"price","subtheme":"expensive"},{"token":"very costly","theme":"price","subtheme":"expensive"},{"token":"best price","theme":"price","subtheme":"affordable price"},{"token":"not worth","theme":"price","subtheme":"expensive"},{"token":"money well spent","theme":"price","subtheme":"affordable price"},{"token":"slightly expensive","theme":"price","subtheme":"expensive"},{"token":"cheaper price","theme":"price","subtheme":"cheaper price"},{"token":"waste of money","theme":"price","subtheme":"expensive"},{"token":"high margin cost","theme":"price","subtheme":"expensive"},{"token":"bit cheaper","theme":"price","subtheme":"cheaper price"},{"token":"worst price","theme":"price","subtheme":"expensive"},{"token":"decent price","theme":"price","subtheme":"affordable price"},{"token":"costly product","theme":"price","subtheme":"expensive"},{"token":"dissatisfied with price","theme":"price","subtheme":"expensive"},{"token":"price is low","theme":"price","subtheme":"cheaper price"},{"token":"standard price","theme":"price","subtheme":"affordable price"},{"token":"a bit costly","theme":"price","subtheme":"expensive"},{"token":"worth for price","theme":"price","subtheme":"affordable price"},{"token":"genuine price","theme":"price","subtheme":"affordable price"},{"token":"very high price","theme":"price","subtheme":"expensive"},{"token":"satisfied with price","theme":"price","subtheme":"affordable price"},{"token":"little bit cheaper","theme":"price","subtheme":"cheaper price"},{"token":"slightly inexpensive","theme":"price","subtheme":"cheaper price"},{"token":"broken handle","theme":"shipping_delivery","subtheme":"damaged product"},{"token":"broken part","theme":"shipping_delivery","subtheme":"damaged product"},{"token":"bad handles","theme":"shipping_delivery","subtheme":"damaged product"},{"token":"fully scratches\u00a0","theme":"shipping_delivery","subtheme":"damaged product"},{"token":"coating came out","theme":"shipping_delivery","subtheme":"damaged product"},{"token":"plastic knob\u00a0broken","theme":"shipping_delivery","subtheme":"damaged product"},{"token":"wooden had crack","theme":"shipping_delivery","subtheme":"damaged product"},{"token":"tremendous delivery","theme":"shipping_delivery","subtheme":"good delivery service"},{"token":"well packed","theme":"shipping_delivery","subtheme":"good packing"},{"token":"arrived on time","theme":"shipping_delivery","subtheme":"good delivery service"},{"token":"worst package","theme":"shipping_delivery","subtheme":"poor packing"},{"token":"inappropriate description","theme":"shipping_delivery","subtheme":"wrong product details"},{"token":"dispatching broken products","theme":"shipping_delivery","subtheme":"damaged product"},{"token":"picture are incorrect","theme":"shipping_delivery","subtheme":"wrong product details"},{"token":"false information","theme":"shipping_delivery","subtheme":"wrong product details"},{"token":"product\u00a0are incorrect","theme":"shipping_delivery","subtheme":"wrong material"},{"token":"package was amazing","theme":"shipping_delivery","subtheme":"good packing"},{"token":"no\u00a0guarantee card","theme":"shipping_delivery","subtheme":"additional details missing"},{"token":"no\u00a0scrubber provided","theme":"shipping_delivery","subtheme":"additional materials needed"},{"token":"incorrect product description","theme":"shipping_delivery","subtheme":"wrong product details"},{"token":"wrong description","theme":"shipping_delivery","subtheme":"wrong product details"},{"token":"supplied broken lid","theme":"shipping_delivery","subtheme":"damaged product"},{"token":"replaced after request","theme":"shipping_delivery","subtheme":"good replacement"},{"token":"received with scratches","theme":"shipping_delivery","subtheme":"damaged product"},{"token":"good as expected","theme":"shipping_delivery","subtheme":"good delivery service"},{"token":"very bad service","theme":"shipping_delivery","subtheme":"poor delivery service"},{"token":"poor service","theme":"shipping_delivery","subtheme":"poor delivery service"},{"token":"excellent service","theme":"shipping_delivery","subtheme":"good delivery service"},{"token":"package not good","theme":"shipping_delivery","subtheme":"poor packing"},{"token":"no damage found","theme":"shipping_delivery","subtheme":"good packing"},{"token":"need replacement","theme":"shipping_delivery","subtheme":"need replacement"},{"token":"perfect replacement","theme":"shipping_delivery","subtheme":"good replacement"},{"token":"nicely packed product","theme":"shipping_delivery","subtheme":"good packing"},{"token":"better than expectations","theme":"shipping_delivery","subtheme":"good delivery service"},{"token":"received without lid","theme":"shipping_delivery","subtheme":"additional materials needed"},{"token":"quick delivery","theme":"shipping_delivery","subtheme":"good delivery service"},{"token":"well packaged","theme":"shipping_delivery","subtheme":"good packing"},{"token":"disappointed with delivery","theme":"shipping_delivery","subtheme":"poor delivery service"},{"token":"got damaged product","theme":"shipping_delivery","subtheme":"damaged product"},{"token":"received defective lid","theme":"shipping_delivery","subtheme":"damaged product"},{"token":"received damage product","theme":"shipping_delivery","subtheme":"damaged product"},{"token":"good delivery service","theme":"shipping_delivery","subtheme":"good delivery service"},{"token":"bad delivery service","theme":"shipping_delivery","subtheme":"poor delivery service"},{"token":"received broken handle","theme":"shipping_delivery","subtheme":"damaged product"},{"token":"prompt delivery","theme":"shipping_delivery","subtheme":"good delivery service"},{"token":"received defect item","theme":"shipping_delivery","subtheme":"damaged product"},{"token":"delivered before expected","theme":"shipping_delivery","subtheme":"good delivery service"},{"token":"box already opened","theme":"shipping_delivery","subtheme":"poor packing"},{"token":"no warranty card","theme":"shipping_delivery","subtheme":"additional details missing"},{"token":"requested to refund","theme":"shipping_delivery","subtheme":"refund"},{"token":"shipped on time\u00a0","theme":"shipping_delivery","subtheme":"good delivery service"},{"token":"early delivery","theme":"shipping_delivery","subtheme":"good delivery service"},{"token":"late delivery","theme":"shipping_delivery","subtheme":"poor delivery service"},{"token":"exchange policy","theme":"shipping_delivery","subtheme":"additional details missing"},{"token":"received used product","theme":"shipping_delivery","subtheme":"need replacement"},{"token":"box was torned","theme":"shipping_delivery","subtheme":"poor packing"},{"token":"delivered used product","theme":"shipping_delivery","subtheme":"need replacement"},{"token":"want to return","theme":"shipping_delivery","subtheme":"need replacement"},{"token":"poor replacement","theme":"shipping_delivery","subtheme":"poor replacement"},{"token":"duplicate product\u00a0image","theme":"shipping_delivery","subtheme":"wrong product details"},{"token":"satisfied with delivery","theme":"shipping_delivery","subtheme":"good delivery service"},{"token":"false product\u00a0description","theme":"shipping_delivery","subtheme":"wrong product details"},{"token":"wrong mrp information","theme":"shipping_delivery","subtheme":"wrong product details"},{"token":"big in size","theme":"size","subtheme":"bigger size"},{"token":"its compact","theme":"size","subtheme":"correct size"},{"token":"strong and heavy","theme":"size","subtheme":"insignificant"},{"token":"perfect size\u00a0","theme":"size","subtheme":"correct size"},{"token":"heavy weight","theme":"size","subtheme":"insignificant"},{"token":"light weight","theme":"size","subtheme":"insignificant"},{"token":"thick body","theme":"size","subtheme":"correct size"},{"token":"quite big","theme":"size","subtheme":"bigger size"},{"token":"little smaller","theme":"size","subtheme":"insignificant"},{"token":"standard size","theme":"size","subtheme":"correct size"},{"token":"comfortable","theme":"size","subtheme":"correct size"},{"token":"very convenient","theme":"size","subtheme":"correct size"},{"token":"good shape","theme":"size","subtheme":"good design"},{"token":"great finesse","theme":"size","subtheme":"good finish"},{"token":"long handle","theme":"size","subtheme":"insignificant"},{"token":"not perfect fit","theme":"size","subtheme":"insignificant"},{"token":"nice finish","theme":"size","subtheme":"good finish"},{"token":"classy look","theme":"size","subtheme":"good design"},{"token":"slightly flat bottom","theme":"size","subtheme":"poor design"},{"token":"fantastic design","theme":"size","subtheme":"good design"},{"token":"shape is round","theme":"size","subtheme":"good design"},{"token":"small in size","theme":"size","subtheme":"insignificant"},{"token":"very small size","theme":"size","subtheme":"insignificant"},{"token":"poor design","theme":"size","subtheme":"poor design"},{"token":"good finish","theme":"size","subtheme":"good finish"},{"token":"not proper round","theme":"size","subtheme":"poor design"},{"token":"no proper size","theme":"size","subtheme":"poor design"},{"token":"no proper shape","theme":"size","subtheme":"poor design"},{"token":"nice look","theme":"size","subtheme":"good looking"},{"token":"heavy glass lid","theme":"size","subtheme":"insignificant"},{"token":"good bottom curvature","theme":"size","subtheme":"good design"},{"token":"looks classy","theme":"size","subtheme":"good looking"},{"token":"design is conventional","theme":"size","subtheme":"good design"},{"token":"unique design","theme":"size","subtheme":"good design"},{"token":"bit higher size","theme":"size","subtheme":"bigger size"},{"token":"bigger in size","theme":"size","subtheme":"bigger size"},{"token":"compatible","theme":"size","subtheme":"good design"},{"token":"little small","theme":"size","subtheme":"insignificant"},{"token":"diameter is huge","theme":"size","subtheme":"bigger size"},{"token":"lid is heavy","theme":"size","subtheme":"insignificant"},{"token":"very well constructed","theme":"size","subtheme":"good design"},{"token":"small than expected","theme":"size","subtheme":"insignificant"},{"token":"dimensions are large","theme":"size","subtheme":"bigger size"},{"token":"quite good size\u00a0","theme":"size","subtheme":"good design"},{"token":"dimensions are small","theme":"size","subtheme":"poor design"},{"token":"small to use","theme":"size","subtheme":"insignificant"},{"token":"very big enough","theme":"size","subtheme":"bigger size"},{"token":"smooth finish","theme":"size","subtheme":"good finish"},{"token":"meticulously designed","theme":"size","subtheme":"good design"},{"token":"size is sufficient","theme":"size","subtheme":"good design"},{"token":"bigger than expected","theme":"size","subtheme":"bigger size"},{"token":"weighs little heavy","theme":"size","subtheme":"insignificant"},{"token":"designed it superbly","theme":"size","subtheme":"good design"},{"token":"little less diameter","theme":"size","subtheme":"insignificant"},{"token":"looks beautiful","theme":"size","subtheme":"good design"},{"token":"awesome product","theme":"quality","subtheme":"superior quality"},{"token":"bad quality","theme":"quality","subtheme":"poor quality"},{"token":"good quality","theme":"quality","subtheme":"superior quality"},{"token":"highly satisfied quality","theme":"quality","subtheme":"superior quality"},{"token":"good product","theme":"quality","subtheme":"superior quality"},{"token":"excellent product","theme":"quality","subtheme":"superior quality"},{"token":"best nonstick pan","theme":"quality","subtheme":"superior quality"},{"token":"strong quality","theme":"quality","subtheme":"superior quality"},{"token":"cheap quality","theme":"quality","subtheme":"poor quality"},{"token":"build quality excellent","theme":"quality","subtheme":"superior quality"},{"token":"highly recommended","theme":"quality","subtheme":"superior quality"},{"token":"low quality","theme":"quality","subtheme":"poor quality"},{"token":"perfect for cooking","theme":"quality","subtheme":"superior quality"},{"token":"thick coating","theme":"quality","subtheme":"superior quality"},{"token":"extremely happy","theme":"quality","subtheme":"superior quality"},{"token":"lid quality good","theme":"quality","subtheme":"superior quality"},{"token":"pan quality good","theme":"quality","subtheme":"superior quality"},{"token":"very smooth","theme":"quality","subtheme":"superior quality"},{"token":"non-stick coating","theme":"quality","subtheme":"superior quality"},{"token":"damage on coating","theme":"quality","subtheme":"poor quality"},{"token":"poor quality","theme":"quality","subtheme":"poor quality"},{"token":"cheap product","theme":"quality","subtheme":"poor quality"},{"token":"cheap materials used","theme":"quality","subtheme":"poor quality"},{"token":"not good quality","theme":"quality","subtheme":"poor quality"},{"token":"pathetic quality","theme":"quality","subtheme":"poor quality"},{"token":"quality so worst","theme":"quality","subtheme":"poor quality"},{"token":"Dissatisfactory product","theme":"quality","subtheme":"poor quality"},{"token":"quality not good","theme":"quality","subtheme":"poor quality"},{"token":"good wooden handles","theme":"quality","subtheme":"superior quality"},{"token":"hard anodised material","theme":"quality","subtheme":"superior quality"},{"token":"satisfied with quality","theme":"quality","subtheme":"superior quality"},{"token":"great build quality","theme":"quality","subtheme":"superior quality"},{"token":"not pure nonstick","theme":"quality","subtheme":"poor quality"},{"token":"cheap nonstick pan","theme":"quality","subtheme":"poor quality"},{"token":"ultra high strength","theme":"quality","subtheme":"superior quality"},{"token":"top notch quality","theme":"quality","subtheme":"superior quality"},{"token":"impressive quality","theme":"quality","subtheme":"superior quality"},{"token":"worst handle quality","theme":"quality","subtheme":"poor quality"},{"token":"low\u00a0quality\u00a0paint","theme":"quality","subtheme":"poor quality"},{"token":"genuine product","theme":"quality","subtheme":"superior quality"},{"token":"absolutely fine material","theme":"quality","subtheme":"superior quality"},{"token":"unpolished handle","theme":"quality","subtheme":"poor quality"},{"token":"superior quality","theme":"quality","subtheme":"superior quality"},{"token":"great buy","theme":"quality","subtheme":"superior quality"},{"token":"sturdy handles","theme":"quality","subtheme":"superior quality"},{"token":"layer peeled off","theme":"quality","subtheme":"poor quality"},{"token":"coating gone","theme":"quality","subtheme":"poor quality"},{"token":"sturdy material","theme":"quality","subtheme":"superior quality"},{"token":"very strong kadhai","theme":"quality","subtheme":"superior quality"},{"token":"handles are strong","theme":"quality","subtheme":"superior quality"},{"token":"screws gone away\u00a0","theme":"quality","subtheme":"poor quality"},{"token":"completely scratched up","theme":"quality","subtheme":"poor quality"},{"token":"looks sturdy","theme":"quality","subtheme":"superior quality"},{"token":"coating came off","theme":"quality","subtheme":"poor quality"},{"token":"thickness is good","theme":"quality","subtheme":"superior quality"},{"token":"thick gauge","theme":"quality","subtheme":"superior quality"},{"token":"very effective coating","theme":"quality","subtheme":"superior quality"},{"token":"good thickness","theme":"quality","subtheme":"superior quality"},{"token":"no scratches","theme":"quality","subtheme":"superior quality"},{"token":"hard non stick","theme":"quality","subtheme":"superior quality"},{"token":"more durable","theme":"quality","subtheme":"superior quality"},{"token":"thick base","theme":"quality","subtheme":"superior quality"},{"token":"good inner coating\u00a0","theme":"quality","subtheme":"superior quality"},{"token":"easy to grab","theme":"operational_effectiveness","subtheme":"easy to use"},{"token":"good to hold","theme":"operational_effectiveness","subtheme":"easy to use"},{"token":"heat resistant","theme":"operational_effectiveness","subtheme":"heat resistant"},{"token":"easier to cook","theme":"operational_effectiveness","subtheme":"adaptable product"},{"token":"multipurpose utility","theme":"operational_effectiveness","subtheme":"adaptable product"},{"token":"easy to hold","theme":"operational_effectiveness","subtheme":"easy to use"},{"token":"stable while cooking","theme":"operational_effectiveness","subtheme":"easy to use"},{"token":"very useful","theme":"operational_effectiveness","subtheme":"adaptable product"},{"token":"food sticks easily","theme":"operational_effectiveness","subtheme":"very sticky"},{"token":"sufficient to cook","theme":"operational_effectiveness","subtheme":"adaptable product"},{"token":"firm handle","theme":"operational_effectiveness","subtheme":"adaptable product"},{"token":"pan heats quicker","theme":"operational_effectiveness","subtheme":"adaptable product"},{"token":"heavy weight pan","theme":"operational_effectiveness","subtheme":"very heavy"},{"token":"retains heat well","theme":"operational_effectiveness","subtheme":"heat resistant"},{"token":"very sticky\u00a0","theme":"operational_effectiveness","subtheme":"very sticky"},{"token":"stability issue","theme":"operational_effectiveness","subtheme":"imbalance"},{"token":"easily slipped off","theme":"operational_effectiveness","subtheme":"imbalance"},{"token":"to much sticky","theme":"operational_effectiveness","subtheme":"very sticky"},{"token":"food sticks frequently","theme":"operational_effectiveness","subtheme":"very sticky"},{"token":"stick very easily","theme":"operational_effectiveness","subtheme":"very sticky"},{"token":"sticks to bottom","theme":"operational_effectiveness","subtheme":"very sticky"},{"token":"easy\u00a0to\u00a0clean\u00a0","theme":"maintenance","subtheme":"easy to clean"},{"token":"low maintenance","theme":"maintenance","subtheme":"low maintenance"},{"token":"easy to maintain","theme":"maintenance","subtheme":"low maintenance"},{"token":"less maintenance","theme":"maintenance","subtheme":"low maintenance"},{"token":"difficult to wash\u00a0","theme":"maintenance","subtheme":"difficult to wash"},{"token":"impossible to maintain","theme":"maintenance","subtheme":"difficult to wash"},{"token":"impossible to clean","theme":"maintenance","subtheme":"difficult to wash"},{"token":"difficult to clean","theme":"maintenance","subtheme":"difficult to wash"},{"token":"easy to manage","theme":"maintenance","subtheme":"low maintenance"},{"token":"tough to Clean","theme":"maintenance","subtheme":"difficult to wash"},{"token":"maintainance is low","theme":"maintenance","subtheme":"low maintenance"},{"token":"easy to wash","theme":"maintenance","subtheme":"easy to clean"}]

df = pd.read_excel("Bigbasket Review.xlsx", encoding='utf-8', keep_default_na=False, na_values=[''], index=False)
df = df.fillna('')
counter = 0
json_data = json.loads(df.to_json(orient='index'))
for sku in json_data:
	review_id = str(json_data[sku]['UID'])
	product_id = str(json_data[sku]['Product_ID']).strip()
	review_title = str(json_data[sku]['Review_Title']).strip()
	review_text = str(json_data[sku]['Review_Text'])
	if review_title == 'n/a':
		review_title = ''
	if review_text == 'n/a':
		review_text = ''
	review_text = review_title + " " + review_text
	if review_text.strip():
		##lower case
		words = review_text.lower().strip()
		##cleaning
		words = re.sub(r'[^A-Za-z0–9\'\`]+', ' ', words)
		words = re.sub(r'\t+|\r+|\s+|\n+', ' ', words.strip())
		words = re.sub(r'\s+', ' ', words.strip())
		match_check = 0
		for m in mentions_text:
			token = m['token']
			token = re.sub(r'[^A-Za-z0–9\'\`]+', ' ', token)
			token = re.sub(r'\t+|\r+|\s+|\n+', ' ', token.strip())
			token = re.sub(r'\s+', ' ', token.strip())
			if token in words:
				match_check = 1
				counter += 1
				onfile.write(str(counter) + "\t" + str(product_id) + "\t" + str(review_id) + "\t" + str(words)
					+ "\t" + str(token) + "\t" + str(m['theme']) + "\t" + str(m['subtheme']) + "\n")
				print("Processed: " + str(counter) + "\n")
		if match_check == 0:
			counter += 1
			onfile.write(str(counter) + "\t" + str(product_id) + "\t" + str(review_id) + "\t" + str(words)
				+ "\tn/a\tNo match\tNo match\n")
			print("Processed: " + str(counter) + "\n")
